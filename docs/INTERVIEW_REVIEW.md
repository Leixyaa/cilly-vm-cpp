# cilly-vm-cpp ????????????????????

????????????????????????????????????????????????????????????????????????????????????????????????????????????

## ??????????????

1. Value / Object / GC ???????????????????????????? GC?????????????? GC??
2. VM ???????operand stack + CallFrame + locals ?????????????
3. Chunk/??????/???????????????????????????????
4. ????????callables ???? OP_CALL/OP_CALLV ?????native pinning ??????
5. OO ????class/instance/bound method/super/init ?????????????????
6. GC ????Mark/Trace/Sweep??roots ??????????bytes ?????????
7. ?????????gtest ???????????????????????????????

## ?????????????????????????

- ???????????? / ???? / ????
- ???????????????????????????????
- ??????/?????????????????????????
- ?? GC / ???????? / roots ?????????????????????????????????????????
- ????????????????? + 2~3 ??????????????

---

## ?? 1 ???Value / Object / GC ???????????????????????

### ???????

- [Value](file:///d:/dev/cilly-vm-cpp/src/value.h)??`ValueType`??`Value` ?? `std::variant` ?????`Obj(...)`/`Callable(...)`
- [Object](file:///d:/dev/cilly-vm-cpp/src/object.h)??`Object : gc::GcObject`????????? `Trace()`/`SizeBytes()`
- [GcObject](file:///d:/dev/cilly-vm-cpp/src/gc/gc_object.h)??mark bit + intrusive next + `Trace(Collector&)`
- [Collector](file:///d:/dev/cilly-vm-cpp/src/gc/gc.h)??`New<T>()`??`CollectWithRoots()`??`Mark()`??RootGuard
- [VM::TraceRoots](file:///d:/dev/cilly-vm-cpp/src/vm.cc#L741-L801)??VM ??????????????????? GC
- [VM::DoCallByIndex(native argv pinning)](file:///d:/dev/cilly-vm-cpp/src/vm.cc#L81-L109)????????? native ?? pin

### ?? 1 ?????????10 ??????????

1. ??? Value ?????????????`ValueType` ?????? Value ?????????[value.h:L39-L42](file:///d:/dev/cilly-vm-cpp/src/value.h#L39-L42)
2. ??? Value ?????????????`type_ + data_(variant)`??[value.h:L45-L120](file:///d:/dev/cilly-vm-cpp/src/value.h#L45-L120)
3. ??????? callable ??????`ValueType::kCallable` ????? `int32_t` ?????????????????[value.h:L49-L52](file:///d:/dev/cilly-vm-cpp/src/value.h#L49-L52)
4. ?? value.cc ?? 3 ????????????`Null/Bool/Num/Str` ?????????[value.cc:L32-L58](file:///d:/dev/cilly-vm-cpp/src/value.cc#L32-L58)
5. ?? `Value::Obj(...)`????????? `Value` ???????????????????????[value.cc:L60-L100](file:///d:/dev/cilly-vm-cpp/src/value.cc#L60-L100)
6. ?? `Value::Callable(int32_t)`???? callable index ??? Value??[value.cc:L102-L107](file:///d:/dev/cilly-vm-cpp/src/value.cc#L102-L107)
7. ?? object.h ????????`class Object : public gc::GcObject`??????????? GC ??????[object.h:L25-L45](file:///d:/dev/cilly-vm-cpp/src/object.h#L25-L45)
8. ?? gc_object.h ?? GC ??????????????????????`marked/next/Trace/SizeBytes`??[gc_object.h:L13-L47](file:///d:/dev/cilly-vm-cpp/src/gc/gc_object.h#L13-L47)
9. ?? gc.cc ?? `Mark` ?? `DrainGrayStack`??Mark ??????????Trace ???????????????[gc.cc:L81-L105](file:///d:/dev/cilly-vm-cpp/src/gc/gc.cc#L81-L105)
10. ?? vm.cc ?? `VM::TraceRoots`??VM ?? `Value` ??????????? `GcObject*` ???? `Mark`??[vm.cc:L741-L801](file:///d:/dev/cilly-vm-cpp/src/vm.cc#L741-L801)

### ??????????????

1) `Value` ??????????????????

- ???????? `std::variant<monostate, bool, double, string, shared_ptr<Object>, int32_t>`???? [value.h:L45-L120](file:///d:/dev/cilly-vm-cpp/src/value.h#L45-L120)
- `ValueType::kObj` ?? `shared_ptr<Object>` ?????`ValueType::kCallable` ?? `int32_t` ???callables_ ?????????? [value.cc:L60-L107](file:///d:/dev/cilly-vm-cpp/src/value.cc#L60-L107)

2) ?????????? GC ???????`Object : gc::GcObject`

- `gc::GcObject` ????mark bit??intrusive next??`SizeBytes()`?????? `Trace()`???? [gc_object.h:L13-L47](file:///d:/dev/cilly-vm-cpp/src/gc/gc_object.h#L13-L47)
- `Object` ???? `GcObject` ?????????????`ObjType`???? `ToRepr()`????????????????? `Trace()` / `SizeBytes()`???? [object.h:L25-L207](file:///d:/dev/cilly-vm-cpp/src/object.h#L25-L207)??[object.cc:L86-L151](file:///d:/dev/cilly-vm-cpp/src/object.cc#L86-L151)

3) `shared_ptr<Object>` ???????????????????? GC ??

- `gc::MakeShared(c, ...)` ????? `Collector::New<T>()` ??????????????? **deleter ? no-op** ?? `shared_ptr`???? [gc.h:L156-L163](file:///d:/dev/cilly-vm-cpp/src/gc/gc.h#L156-L163)
- ???????`shared_ptr` ?????? delete???????????? `Collector::Sweep()` ?? `FreeAll()` ?????? [gc.cc:L67-L80](file:///d:/dev/cilly-vm-cpp/src/gc/gc.cc#L67-L80)??[gc.cc:L107-L141](file:///d:/dev/cilly-vm-cpp/src/gc/gc.cc#L107-L141)

4) GC ?????? roots ????????????Mark ?? Trace ?? Sweep

- `CollectWithRoots(trace_roots)`????????? roots?????? VM ?? roots????? drain gray stack???? sweep???? [gc.h:L48-L68](file:///d:/dev/cilly-vm-cpp/src/gc/gc.h#L48-L68)
- `Mark(obj)`???????????????????? mark??????? gray ???? `Trace()`???? [gc.cc:L81-L104](file:///d:/dev/cilly-vm-cpp/src/gc/gc.cc#L81-L104)
- `Sweep()`?????? all_objects_ ???????????? delete??????? bytes ?????? [gc.cc:L107-L141](file:///d:/dev/cilly-vm-cpp/src/gc/gc.cc#L107-L141)

### ??????????????????? Value ?? GC ???????????

????????????**Value??shared_ptr ????? ?? raw pointer??GcObject*?? ?? Mark/Trace ?? ????**

- ?????? `Value`??`Value::Obj(shared_ptr<ObjX>)`???? [value.cc:L60-L100](file:///d:/dev/cilly-vm-cpp/src/value.cc#L60-L100)
- ??????? GC ??????????????????? root ?????? `Value::AsObj().get()` ???? `Collector::Mark()`???? [vm.cc:L741-L748](file:///d:/dev/cilly-vm-cpp/src/vm.cc#L741-L748)
- GC ???? Trace ??????????????????
  - list??????????????? `Value`?????? obj ?? mark???? [object.cc:L88-L93](file:///d:/dev/cilly-vm-cpp/src/object.cc#L88-L93)
  - dict?????? entries ?? value?????? obj ?? mark???? [object.cc:L97-L102](file:///d:/dev/cilly-vm-cpp/src/object.cc#L97-L102)
  - instance??mark `klass` ?? `fields`??fields ?????? ObjDict GC ??????? [object.cc:L115-L124](file:///d:/dev/cilly-vm-cpp/src/object.cc#L115-L124)
  - bound method??mark `receiver`???? [object.cc:L128-L131](file:///d:/dev/cilly-vm-cpp/src/object.cc#L128-L131)

### ??????/??????????????????????????? bug??

1) **shared_ptr ??????????????????????**

- ??? deleter ?? no-op??`shared_ptr` ??????????????????? delete????????????? `shared_ptr` ??????? GC ????????? root ?????Sweep ??? delete ?????
- ??????????????????**?????????????????????????? roots ???**??

2) **??root ?????????????????????**

VM ??????????????????????????????

- operand stack???? [vm.cc:L750-L753](file:///d:/dev/cilly-vm-cpp/src/vm.cc#L750-L753)
- ??? frame ?? locals + `instance_to_return`???? [vm.cc:L758-L765](file:///d:/dev/cilly-vm-cpp/src/vm.cc#L758-L765)
- `last_return_value_`???? [vm.cc:L767-L768](file:///d:/dev/cilly-vm-cpp/src/vm.cc#L767-L768)
- ???????????????????????? chunk ?????? + ???????? bytecode callable ?????????? [vm.cc:L770-L800](file:///d:/dev/cilly-vm-cpp/src/vm.cc#L770-L800)

3) **???? native ????? pin argv???????? UAF??**

- native ???C++ ??????? `argv`/???????????? VM ?? operand stack / locals ?????????? roots ??????
- ??? native ??????? GC???????????????????????????????? Sweep ??
- ????????? native ??? argv ?????? Obj ??? PushRoot??????? PopRoot???? [vm.cc:L87-L106](file:///d:/dev/cilly-vm-cpp/src/vm.cc#L87-L106)??[gc.h:L77-L79](file:///d:/dev/cilly-vm-cpp/src/gc/gc.h#L77-L79)

4) **???????????????????? bytes budget?????????????**

- `SizeBytes()` ???????? capacity/bucket ????????? [object.cc:L134-L151](file:///d:/dev/cilly-vm-cpp/src/object.cc#L134-L151)
- Collector ??? `heap_bytes_`??????????? `AddHeapBytesDelta(delta)` ?????????????? [gc.h:L89-L90](file:///d:/dev/cilly-vm-cpp/src/gc/gc.h#L89-L90)??[gc.cc:L42-L61](file:///d:/dev/cilly-vm-cpp/src/gc/gc.cc#L42-L61)

### ?? GC / ???????? / roots ???????????????? GC?????????

- ?????VM ???????????? `GcSafePoint_()`????????? `CollectGarbage()`???? [vm.cc:L803-L843](file:///d:/dev/cilly-vm-cpp/src/vm.cc#L803-L843)
- ??????**?? safepoint ????????????????????? roots ???**??operand stack/locals/??????/??? roots????
- ??????GC ?????????????????????????? magic?????? root ??????????

### ??????

?????????

- ??? VM ?? `Value` ?? `variant` ????????????????? `shared_ptr<Object>` ?????????????????? Mark?CSweep GC ??????GC ?? VM ???? roots???/locals/??????/??? roots??????????????Sweep ??????????????????????????????????

?????? 1???????? `shared_ptr`???????????/?????

- ?? `shared_ptr` ????????????????????????? C++ ???????????????? `variant` ?????????????????????? GC??`MakeShared` ?? deleter ?? no-op???????? Value ??????????????????????????????????

?????? 2????? `shared_ptr` ???????GC ????? delete ????

- ??? `shared_ptr` ??????????????????deleter no-op????????????????????? roots ????????? VM roots ????????????????????????????????? UAF?????????????

?????? 3??native ??????????? pin argv?????? pin ????????

- native ???????????????? C++ ????????????? VM ?? stack/locals????? GC ???????????????????????????????????????????? UAF??pinning ?? `PushRoot/PopRoot` ??????????? roots????? GC ????????

